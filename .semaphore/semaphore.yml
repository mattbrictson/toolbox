version: v1.0
name: Example Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
execution_time_limit:
  minutes: 30
blocks:
  - name: Static Code Analysis
    dependencies: []
    task:
      prologue:
        commands:
          - sem-version go 1.16
          - export GOPATH=~/go
          - 'export PATH=/home/semaphore/go/bin:$PATH'
          - checkout
      jobs:
        - name: go fmt --check
          commands:
            - cd cache-cli
            - make build OS=linux
            - make build OS=darwin
            - artifact push workflow bin/linux/cache -d bin/linux/cache
            - artifact push workflow bin/darwin/cache -d bin/darwin/cache
        - name: revive
          commands: []
  - name: Unit Tests
    dependencies:
      - Static Code Analysis
    task:
      prologue:
        commands:
          - checkout
          - artifact pull workflow bin/linux/cache -d cache-cli/bin/linux/cache
          - artifact pull workflow bin/darwin/cache -d cache-cli/bin/darwin/cache
          - bash release/create.sh
          - source release/install_in_tests.sh
          - git submodule init && git submodule update
          - sudo ./tests/support/bats-core/install.sh /usr/local
      jobs:
        - name: make test
          commands:
            - 'bats tests/sem_version_bionic/${TEST}.bats'
          parallelism: 10
  - name: Integration Tests
    run:
      when: change_in("*")
    dependencies:
      - Unit Tests
    task:
      jobs:
        - name: make int.test
          commands: []
          parallelism: 4
after_pipeline:
  task:
    jobs:
      - name: Submit Reports
        commands:
          - test-results gen-pipeline-report
promotions:
  - name: Release
    pipeline_file: release.yml
    auto_promote_on:
      - result: passed
        branch:
          - ^refs/tags/v*
